# Docker + FastAPI 構築 学習メモ

## 概要
DockerコンテナでFastAPIアプリケーションを構築・実行する基本的な方法

## ファイル構成

### 1. **requirements.txt** - Python依存パッケージ管理
```txt
fastapi==0.104.1
uvicorn==0.24.0
python-dotenv==1.0.0
```

**役割:** Pythonプロジェクトで必要なライブラリとバージョンを指定
- **fastapi**: Webフレームワーク
- **uvicorn**: ASGIサーバー（FastAPIアプリを実行するサーバー）
- **python-dotenv**: 環境変数を.envファイルから読み込む

---

### 2. **Dockerfile** - Dockerイメージ定義
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY main.py .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**各行の解説:**

| 行 | コマンド | 説明 |
|---|---------|------|
| 1 | `FROM python:3.11-slim` | ベースイメージを指定。python 3.11の軽量版を使用 |
| 3 | `WORKDIR /app` | コンテナ内の作業ディレクトリを `/app` に設定 |
| 5 | `COPY requirements.txt .` | ホスト側のrequirements.txtをコンテナ内の現在ディレクトリにコピー |
| 6 | `RUN pip install --no-cache-dir -r requirements.txt` | 依存パッケージをインストール（キャッシュなし）|
| 8 | `COPY main.py .` | FastAPIアプリケーションをコンテナ内にコピー |
| 10 | `CMD [...]` | コンテナ起動時に実行するコマンド（uvicornサーバー起動）|

**ポイント:**
- `--no-cache-dir`: イメージサイズを削減するためのオプション
- `0.0.0.0`: すべてのインターフェースからアクセス可能
- ポート `8000`: FastAPI/uvicornのデフォルトポート

---

### 3. **docker-compose.yml** - マルチコンテナ管理
```yaml
version: '3.8'
services:
  fastapi:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    environment:
      - ENV=development
```

**各設定の説明:**

| キー | 値 | 説明 |
|-----|-----|------|
| `version` | `3.8` | Docker Composeファイル形式のバージョン |
| `services.fastapi.build` | `.` | 現在のディレクトリのDockerfileをビルド |
| `ports` | `8000:8000` | ホストのポート8000 → コンテナのポート8000をマッピング |
| `volumes` | `.:/app` | ホスト側の現在ディレクトリ → コンテナの/appに同期（開発時の自動リロード用）|
| `environment` | `ENV=development` | コンテナ内の環境変数を設定 |

**volumesの利点:**
- ファイル編集時にコンテナ内も自動的に反映される（開発効率向上）
- Pythonはホットリロード機能により、ファイル変更を検出して再起動

---

### 4. **main.py** - FastAPIアプリケーション
```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello, Docker + FastAPI!"}

@app.get("/items/{item_id}")
def read_item(item_id: int, q: str = None):
    return {"item_id": item_id, "q": q}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**エンドポイント解説:**

| エンドポイント | メソッド | 説明 |
|-------------|---------|------|
| `/` | GET | ルートエンドポイント。メッセージを返す |
| `/items/{item_id}` | GET | パス変数 `item_id` とクエリパラメータ `q` を受け取る |

**Postmanでのテスト例:**
```
GET http://localhost:8000/
→ {"message": "Hello, Docker + FastAPI!"}

GET http://localhost:8000/items/5?q=test
→ {"item_id": 5, "q": "test"}
```

---

## 実行コマンド

### ビルド・起動（docker-compose使用）
```bash
docker-compose up --build
```
- `--build`: 変更があればイメージを再ビルド
- コンテナがバックグラウンドで実行される

### バックグラウンド実行
```bash
docker-compose up -d
```

### ログ確認
```bash
docker-compose logs -f
```

### 停止
```bash
docker-compose down
```

---

## 学習ポイント

✅ **Dockerの基本フロー:**
1. ベースイメージ選択 → 依存関係インストール → アプリケーション配置 → 実行コマンド定義

✅ **docker-composeの利点:**
- 複雑なコマンドをYAML形式で管理
- 複数サービス管理が容易
- volumes設定で開発効率向上

✅ **FastAPI + Uvicornの役割分担:**
- **FastAPI**: APIロジック定義
- **Uvicorn**: HTTPサーバー（リクエスト受け取り・レスポンス送信）

✅ **ポートマッピング:**
- ホストのポート → コンテナのポート
- 隔離されたコンテナから外部からアクセス可能

---

この構成で、環境に依存しない再現性の高いアプリケーション開発が可能になります！
