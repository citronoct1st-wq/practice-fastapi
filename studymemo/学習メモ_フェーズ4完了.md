# FastAPI Ã— PostgreSQL ãƒ•ã‚§ãƒ¼ã‚º4 èªè¨¼ãƒ»èªå¯ å®Œäº†ãƒ¡ãƒ¢

## å­¦ç¿’æˆæœ

âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ã‚¢ãƒãƒƒã‚·ãƒ³ã‚°ï¼ˆbcryptï¼‰ã‚’å®Ÿè£…
âœ… JWT ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»æ¤œè¨¼æ©Ÿèƒ½ã®æ§‹ç¯‰
âœ… Bearer ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã®å®Ÿè£…
âœ… ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰ã®å®Ÿè£…
âœ… ä¾å­˜æ€§æ³¨å…¥ï¼ˆDependency Injectionï¼‰ã‚’æ´»ç”¨ã—ãŸèªè¨¼ãƒ•ãƒ­ãƒ¼
âœ… HTTPã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆ401, 403ï¼‰ã®é©åˆ‡ãªä½¿ã„åˆ†ã‘
âœ… ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆï¼ˆadmin æ¨©é™ç®¡ç†ï¼‰

---

## å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### 1. requirements.txt - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ 

```txt
fastapi==0.104.1
uvicorn==0.24.0
python-dotenv==1.0.0

sqlalchemy==2.0.23          # ORM ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
psycopg2-binary==2.9.9      # PostgreSQLç”¨ãƒ‰ãƒ©ã‚¤ãƒãƒ¼
alembic==1.12.1             # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
pydantic[email]

bcrypt==4.1.1               # â† æ–°è¦ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ³ã‚°
passlib==1.7.4              # â† æ–°è¦ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
python-jose==3.3.0          # â† æ–°è¦ï¼šJWTç”Ÿæˆ
python-multipart==0.0.6     # â† æ–°è¦ï¼šãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å‡¦ç†
```

**ãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª:**

| ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç›®çš„ |
|----------|-----------|------|
| `bcrypt` | 4.1.1 | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å®‰å…¨ãƒãƒƒã‚·ãƒ³ã‚° |
| `passlib` | 1.7.4 | bcrypt ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ï¼‰ |
| `python-jose` | 3.3.0 | JWT ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»æ¤œè¨¼ |
| `python-multipart` | 0.0.6 | ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å‡¦ç† |

---

### 2. models.py - User ãƒ¢ãƒ‡ãƒ«ä¿®æ­£

```python
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from datetime import datetime
from database import Base

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    name = Column(String(255), nullable=False)
    email = Column(String(255), unique=True, nullable=False, index=True)
    hashed_password = Column(String(255), nullable=False)      # â† æ–°è¦
    role = Column(String(50), default="user", nullable=False)  # â† æ–°è¦
    is_active = Column(Boolean, default=True, nullable=False)  # â† æ–°è¦
    created_at = Column(DateTime, default=datetime.utcnow)

    def __repr__(self):
        return f"<User(id={self.id}, name={self.name}, email={self.email}, role={self.role})>"
```

**ãƒ•ã‚§ãƒ¼ã‚º4ã§ã®æ–°è¦ã‚«ãƒ©ãƒ :**

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| `hashed_password` | String(255) | bcrypt ã§ãƒãƒƒã‚·ãƒ³ã‚°åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ |
| `role` | String(50) | ãƒ­ãƒ¼ãƒ«ï¼ˆ"user" ã¾ãŸã¯ "admin"ï¼‰ |
| `is_active` | Boolean | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ |

**é‡è¦:** `password` ã§ã¯ãªã `hashed_password` ã‚’ä½¿ç”¨ï¼ˆå¾©å·ä¸å¯ï¼‰

---

### 3. schemas.py - Pydantic ã‚¹ã‚­ãƒ¼ãƒä¿®æ­£

```python
from pydantic import BaseModel, EmailStr
from typing import Optional
from datetime import datetime

# ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨ã‚¹ã‚­ãƒ¼ãƒ =====
class UserCreate(BaseModel):
    name: str
    email: EmailStr
    password: str  # â† æ–°è¦ï¼šå¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç™»éŒ²æ™‚ã®ã¿ä½¿ç”¨ï¼‰

# ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ç”¨ã‚¹ã‚­ãƒ¼ãƒ =====
class UserUpdate(BaseModel):
    name: Optional[str] = None
    email: Optional[EmailStr] = None

# ===== ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã‚¹ã‚­ãƒ¼ãƒ =====
class UserResponse(BaseModel):
    id: int
    name: str
    email: str
    role: str
    is_active: bool
    created_at: datetime

    class Config:
        from_attributes = True

# ===== ãƒˆãƒ¼ã‚¯ãƒ³ç”¨ã‚¹ã‚­ãƒ¼ãƒ =====
class TokenPayload(BaseModel):
    user_id: int
    email: str
    role: str
    exp: int  # JWT å¤±åŠ¹æ™‚åˆ»ï¼ˆUnix Timestampï¼‰

# ===== ãƒ­ã‚°ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹ =====
class LoginResponse(BaseModel):
    access_token: str
    token_type: str
    user: UserResponse
```

**æ–°è¦ã‚¹ã‚­ãƒ¼ãƒ:**

| ã‚¹ã‚­ãƒ¼ãƒ | ç”¨é€” |
|---------|------|
| `UserCreate` | `password` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ï¼‰ |
| `TokenPayload` | JWT ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆuser_id, email, role, expï¼‰ |
| `LoginResponse` | ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ |

---

### 4. security.py - èªè¨¼ãƒ»èªå¯ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```python
from passlib.context import CryptContext
from datetime import datetime, timedelta, timezone
from typing import Optional, Annotated
from jose import JWTError, jwt
from fastapi import Depends, HTTPException, status, Header
from sqlalchemy.orm import Session
from schemas import TokenPayload
from database import get_db
from models import User

# ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æš—å·åŒ–è¨­å®š ==========
pwd_context = CryptContext(
    schemes=["bcrypt"],           # bcrypt ã‚’ä½¿ç”¨
    deprecated="auto"
)

# ========== JWT è¨­å®š ==========
SECRET_KEY = "your-secret-key-change-in-production"  # âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60  # ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ï¼š60åˆ†

# ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–¢é€£é–¢æ•° ==========
def hash_password(password: str) -> str:
    """å¹³æ–‡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ³ã‚°

    Args:
        password: å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

    Returns:
        ãƒãƒƒã‚·ãƒ³ã‚°åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

    ä¾‹:
        >>> hash_password("password123")
        '$2b$12$...'
    """
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒãƒãƒƒã‚·ãƒ¥ã¨ä¸€è‡´ã™ã‚‹ã‹æ¤œè¨¼

    Args:
        plain_password: å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        hashed_password: ãƒãƒƒã‚·ãƒ³ã‚°åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

    Returns:
        bool: ä¸€è‡´ã™ã‚Œã° Trueã€ä¸ä¸€è‡´ãªã‚‰ False

    ä¾‹:
        >>> hash_pw = hash_password("password123")
        >>> verify_password("password123", hash_pw)
        True
    """
    return pwd_context.verify(plain_password, hashed_password)

# ========== JWT é–¢é€£é–¢æ•° ==========
def create_access_token(
    user_id: int,
    email: str,
    role: str,
    expires_delta: Optional[timedelta] = None
) -> str:
    """JWT ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ

    Args:
        user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        role: ãƒ­ãƒ¼ãƒ«ï¼ˆadmin, userï¼‰
        expires_delta: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 60åˆ†ï¼‰

    Returns:
        JWT ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—

    ä¾‹:
        >>> token = create_access_token(user_id=1, email="user@example.com", role="user")
        >>> # ãƒˆãƒ¼ã‚¯ãƒ³ï¼šeyJ... (JWT)
    """
    if expires_delta:
        expire = datetime.now(timezone.utc) + expires_delta
    else:
        expire = datetime.now(timezone.utc) + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)

    payload = {
        "user_id": user_id,
        "email": email,
        "role": role,
        "exp": int(expire.timestamp())  # Unix Timestamp
    }

    encoded_jwt = jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

def verify_token(token: str) -> Optional[TokenPayload]:
    """JWT ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¦ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å–å¾—

    Args:
        token: JWT ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—

    Returns:
        TokenPayload: ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆç„¡åŠ¹ãªã‚‰ Noneï¼‰

    ä¾‹:
        >>> token = "eyJ..."
        >>> payload = verify_token(token)
        >>> if payload:
        ...     print(f"User ID: {payload.user_id}")
    """
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return TokenPayload(**payload)
    except JWTError:
        return None

# ========== èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º ==========
def _extract_token_from_header(authorization: str | None = Header(None)) -> str:
    """Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ Bearer ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º

    Args:
        authorization: Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè‡ªå‹•æ³¨å…¥ï¼‰

    Returns:
        str: ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—

    Raises:
        HTTPException 401: Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„ã€ã¾ãŸã¯å½¢å¼ãŒé•ã†

    ä¾‹:
        Authorization: Bearer eyJ...
    """
    if not authorization:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¿…è¦ã§ã™",
            headers={"WWW-Authenticate": "Bearer"}
        )

    parts = authorization.split()
    if len(parts) != 2 or parts[0].lower() != "bearer":
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ç„¡åŠ¹ãª Authorization ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã§ã™",
            headers={"WWW-Authenticate": "Bearer"}
        )

    return parts[1]

# ========== ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹ä¾å­˜æ€§é–¢æ•° ==========
def get_current_user(
    token: Annotated[str, Depends(_extract_token_from_header)],
    db: Session = Depends(get_db)
) -> User:
    """ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—

    Args:
        token: JWT ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆAuthorization ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰è‡ªå‹•æŠ½å‡ºï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        User: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

    Raises:
        HTTPException 401: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ

    ä¾‹:
        @router.get("/profile")
        def get_profile(user: User = Depends(get_current_user)):
            return user
    """
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
    payload = verify_token(token)
    if not payload:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ã™",
            headers={"WWW-Authenticate": "Bearer"}
        )

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ DB ã‹ã‚‰å–å¾—
    user = db.query(User).filter(User.id == payload.user_id).first()
    if not user or not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
            headers={"WWW-Authenticate": "Bearer"}
        )

    return user

def get_current_admin(
    current_user: User = Depends(get_current_user)
) -> User:
    """ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ admin ãƒ­ãƒ¼ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

    Args:
        current_user: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼

    Returns:
        User: admin ãƒ­ãƒ¼ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼

    Raises:
        HTTPException 403: admin ãƒ­ãƒ¼ãƒ«ã§ã¯ãªã„

    ä¾‹:
        @router.delete("/users/{user_id}")
        def delete_user(user_id: int, admin: User = Depends(get_current_admin)):
            # ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ admin ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    """
    if current_user.role != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="ã“ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç®¡ç†è€…ã®ã¿å®Ÿè¡Œå¯èƒ½ã§ã™"
        )
    return current_user
```

**security.py ã®ä¸»è¦æ©Ÿèƒ½:**

| é–¢æ•° | ç›®çš„ |
|------|------|
| `hash_password()` | å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ â†’ bcrypt ãƒãƒƒã‚·ãƒ¥ |
| `verify_password()` | å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ã¨ ãƒãƒƒã‚·ãƒ¥ ã®æ¯”è¼ƒ |
| `create_access_token()` | JWT ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ |
| `verify_token()` | JWT ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ |
| `_extract_token_from_header()` | Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ â†’ Bearer ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡º |
| `get_current_user()` | èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆä¾å­˜æ€§ï¼‰ |
| `get_current_admin()` | admin ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªï¼ˆä¾å­˜æ€§ï¼‰ |

---

### 5. routers/users.py - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿®æ­£

```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from sqlalchemy.exc import IntegrityError
from database import get_db
from models import User
from schemas import UserCreate, UserResponse, UserUpdate, LoginResponse
from security import (
    hash_password, verify_password,
    create_access_token,
    get_current_user, get_current_admin
)

router = APIRouter(prefix="/users", tags=["users"])

# ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆèªè¨¼ä¸è¦ï¼‰==========
@router.post("", response_model=UserResponse, status_code=status.HTTP_201_CREATED)
def create_user(user: UserCreate, db: Session = Depends(get_db)):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    Args:
        user: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨ã‚¹ã‚­ãƒ¼ãƒï¼ˆname, email, passwordï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        UserResponse: ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    Raises:
        HTTPException 409: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
    """
    try:
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ³ã‚°
        hashed_password = hash_password(user.password)

        # æ–°è¦ User ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆrole ã¯è‡ªå‹•çš„ã« "user"ï¼‰
        db_user = User(
            name=user.name,
            email=user.email,
            hashed_password=hashed_password,
            role="user"  # â† ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ­ãƒ¼ãƒ«
        )

        db.add(db_user)
        db.commit()
        db.refresh(db_user)

        return db_user

    except IntegrityError:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"
        )

# ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆèªè¨¼ä¸è¦ï¼‰==========
@router.post("/login", response_model=LoginResponse)
def login(email: str, password: str, db: Session = Depends(get_db)):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    Args:
        email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        password: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¹³æ–‡ï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        LoginResponse: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    Raises:
        HTTPException 401: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„
    """
    # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    db_user = db.query(User).filter(User.email == email).first()

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„
    if not db_user or not verify_password(password, db_user.hashed_password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"
        )

    # JWT ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    access_token = create_access_token(
        user_id=db_user.id,
        email=db_user.email,
        role=db_user.role
    )

    return LoginResponse(
        access_token=access_token,
        token_type="bearer",
        user=db_user
    )

# ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ3: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆadmin èªè¨¼å¿…é ˆï¼‰==========
@router.get("", response_model=list[UserResponse])
def read_users(
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆadmin ã®ã¿ï¼‰

    Args:
        admin: èªè¨¼æ¸ˆã¿ admin ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè‡ªå‹•æ³¨å…¥ï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        list[UserResponse]: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒªã‚¹ãƒˆ

    Raises:
        HTTPException 403: admin ãƒ­ãƒ¼ãƒ«ã§ã¯ãªã„
    """
    users = db.query(User).all()
    return users

# ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ4: ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆuser èªè¨¼å¿…é ˆï¼‰==========
@router.get("/{user_id}", response_model=UserResponse)
def read_user(
    user_id: int,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    Args:
        user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        current_user: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè‡ªå‹•æ³¨å…¥ï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        UserResponse: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    Raises:
        HTTPException 404: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„
        HTTPException 403: ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§ã¯ä¸å¯
    """
    # ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§ã¯ä¸å¯ï¼ˆæœ¬äººã¾ãŸã¯adminã®ã¿ï¼‰
    if current_user.id != user_id and current_user.role != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"
        )

    db_user = db.query(User).filter(User.id == user_id).first()

    if not db_user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        )

    return db_user

# ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ5: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ï¼ˆæœ¬äººã¾ãŸã¯adminï¼‰==========
@router.put("/{user_id}", response_model=UserResponse)
def update_user(
    user_id: int,
    user_update: UserUpdate,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    Args:
        user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        user_update: æ›´æ–°å†…å®¹ï¼ˆname, email ã¯ä»»æ„ï¼‰
        current_user: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè‡ªå‹•æ³¨å…¥ï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        UserResponse: æ›´æ–°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    Raises:
        HTTPException 403: æ¨©é™ãŒãªã„
        HTTPException 404: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„
    """
    # æœ¬äººã¾ãŸã¯admin ã®ã¿æ›´æ–°å¯èƒ½
    if current_user.id != user_id and current_user.role != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã¯ç·¨é›†ã§ãã¾ã›ã‚“"
        )

    db_user = db.query(User).filter(User.id == user_id).first()

    if not db_user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        )

    try:
        # ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ›´æ–°
        if user_update.name is not None:
            db_user.name = user_update.name

        if user_update.email is not None:
            db_user.email = user_update.email

        db.commit()
        db.refresh(db_user)

        return db_user

    except IntegrityError:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"
        )

# ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ6: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆadmin ã®ã¿ï¼‰==========
@router.delete("/{user_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_user(
    user_id: int,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆadmin ã®ã¿ï¼‰

    Args:
        user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        admin: èªè¨¼æ¸ˆã¿ admin ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè‡ªå‹•æ³¨å…¥ï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Raises:
        HTTPException 403: admin ãƒ­ãƒ¼ãƒ«ã§ã¯ãªã„
        HTTPException 404: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„
    """
    db_user = db.query(User).filter(User.id == user_id).first()

    if not db_user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        )

    db.delete(db_user)
    db.commit()

# ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ7: admin ã«ã‚ˆã‚‹æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ ==========
@router.post("/admin/create", response_model=UserResponse, status_code=status.HTTP_201_CREATED)
def create_user_by_admin(
    user: UserCreate,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆadmin å°‚ç”¨ï¼‰

    Args:
        user: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨ã‚¹ã‚­ãƒ¼ãƒï¼ˆname, email, passwordï¼‰
        admin: èªè¨¼æ¸ˆã¿ admin ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè‡ªå‹•æ³¨å…¥ï¼‰
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        UserResponse: ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    Raises:
        HTTPException 403: admin ãƒ­ãƒ¼ãƒ«ã§ã¯ãªã„
        HTTPException 409: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
    """
    try:
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ³ã‚°
        hashed_password = hash_password(user.password)

        # æ–°è¦ User ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆrole ã¯è‡ªå‹•çš„ã« "user"ï¼‰
        db_user = User(
            name=user.name,
            email=user.email,
            hashed_password=hashed_password,
            role="user"  # â† admin ãŒä½œæˆã—ã¦ã‚‚ "user" ãƒ­ãƒ¼ãƒ«
        )

        db.add(db_user)
        db.commit()
        db.refresh(db_user)

        return db_user

    except IntegrityError:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"
        )
```

**ãƒ•ã‚§ãƒ¼ã‚º4ã§ã®æ–°è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èªè¨¼ | èª¬æ˜ |
|---------|------|------|------|
| `POST` | `/users` | ä¸è¦ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² |
| `POST` | `/users/login` | ä¸è¦ | ãƒ­ã‚°ã‚¤ãƒ³ï¼†ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— |
| `GET` | `/users` | admin | å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾— |
| `GET` | `/users/{id}` | user | ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾— |
| `PUT` | `/users/{id}` | user | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–° |
| `DELETE` | `/users/{id}` | admin | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ |
| `POST` | `/users/admin/create` | admin | admin ã«ã‚ˆã‚‹æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ |

---

### 6. Dockerfile - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY main.py .
COPY database.py .
COPY models.py .
COPY schemas.py .
COPY security.py           # â† æ–°è¦ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
COPY routers .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**ãƒ•ã‚§ãƒ¼ã‚º4ã§ã®è¿½åŠ :**

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| `security.py` | JWTãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ³ã‚°ãƒ»èªå¯ãƒ­ã‚¸ãƒƒã‚¯ |

---

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆãƒ•ã‚§ãƒ¼ã‚º4å®Œäº†æ™‚ï¼‰

```
practice-fastapi/
â”œâ”€â”€ Dockerfile                              âœ… security.pyè¿½åŠ 
â”œâ”€â”€ compose.yml                             ï¼ˆå¤‰æ›´ãªã—ï¼‰
â”œâ”€â”€ requirements.txt                        âœ… ä¿®æ­£ï¼ˆ4ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ ï¼‰
â”œâ”€â”€ main.py                                 ï¼ˆå¤‰æ›´ãªã—ï¼‰
â”œâ”€â”€ database.py                             ï¼ˆå¤‰æ›´ãªã—ï¼‰
â”œâ”€â”€ models.py                               âœ… ä¿®æ­£ï¼ˆ3ã‚«ãƒ©ãƒ è¿½åŠ ï¼‰
â”œâ”€â”€ schemas.py                              âœ… ä¿®æ­£ï¼ˆTokenPayloadç­‰è¿½åŠ ï¼‰
â”œâ”€â”€ security.py                             âœ… æ–°è¦ï¼ˆèªè¨¼ãƒ»èªå¯ï¼‰
â”œâ”€â”€ routers/                                âœ… ä¿®æ­£
â”‚   â”œâ”€â”€ __init__.py                        ï¼ˆå¤‰æ›´ãªã—ï¼‰
â”‚   â””â”€â”€ users.py                           âœ… ä¿®æ­£ï¼ˆ7ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
â”œâ”€â”€ .gitignore                              ï¼ˆå¤‰æ›´ãªã—ï¼‰
â””â”€â”€ studymemo/
    â”œâ”€â”€ å­¦ç¿’ãƒ¡ãƒ¢_ãƒ•ã‚§ãƒ¼ã‚º1å®Œäº†.md
    â”œâ”€â”€ å­¦ç¿’ãƒ¡ãƒ¢_ãƒ•ã‚§ãƒ¼ã‚º2å®Œäº†.md
    â”œâ”€â”€ å­¦ç¿’ãƒ¡ãƒ¢_ãƒ•ã‚§ãƒ¼ã‚º3å®Œäº†.md
    â””â”€â”€ å­¦ç¿’ãƒ¡ãƒ¢_ãƒ•ã‚§ãƒ¼ã‚º4å®Œäº†.md            â† æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
```

---

## å®Ÿè£…ã®æµã‚Œ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼špassword123
    â†“
1. hash_password() ã§ bcrypt ãƒãƒƒã‚·ãƒ³ã‚°
    â†“
2. DB ã«ä¿å­˜ï¼š$2b$12$...ï¼ˆå¾©å·ä¸å¯ï¼‰
    â†“
æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†ï¼ˆrole: "user"ï¼‰
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆ201 Createdï¼‰:**
```json
{
  "id": 1,
  "name": "å±±ç”°å¤ªéƒ",
  "email": "yamada@example.com",
  "role": "user",
  "is_active": true,
  "created_at": "2025-11-06T12:00:00"
}
```

---

### ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼šemail, password
    â†“
1. DB ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«æ¤œç´¢
    â†“
2. verify_password() ã§æ¤œè¨¼
    â†“
3. create_access_token() ã§ JWT ç”Ÿæˆ
    â†“
4. LoginResponse ã§è¿”å´
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```bash
POST /users/login
email=yamada@example.com
password=password123
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆ200 OKï¼‰:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "name": "å±±ç”°å¤ªéƒ",
    "email": "yamada@example.com",
    "role": "user",
    "is_active": true,
    "created_at": "2025-11-06T12:00:00"
  }
}
```

---

### èªè¨¼ä»˜ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‘¼ã³å‡ºã—ãƒ•ãƒ­ãƒ¼

```
GET /users/{user_id}
Authorization: Bearer {access_token}
    â†“
1. Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ Bearer ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡º
    â†“
2. verify_token() ã§ JWT æ¤œè¨¼
    â†“
3. ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ ã‹ã‚‰ user_id å–å¾—
    â†“
4. DB ã‹ã‚‰ User ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—
    â†“
5. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè¡Œ
```

**cURL ä¾‹:**
```bash
curl -X GET "http://localhost:8000/users/1" \
  -H "Authorization: Bearer eyJhbGci..."
```

---

### ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰ãƒ•ãƒ­ãƒ¼

```
GET /usersï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼‰
Authorization: Bearer {admin_token}
    â†“
1. get_current_admin() ã§ admin ãƒ­ãƒ¼ãƒ«ç¢ºèª
    â†“
   admin ãƒ­ãƒ¼ãƒ«ç¢ºèª â†’ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè¡Œ
   user ãƒ­ãƒ¼ãƒ« â†’ 403 Forbiddenï¼ˆã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ï¼‰
    â†“
ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

**ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¡¨:**

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | user | admin | èª¬æ˜ |
|------------|------|-------|------|
| `POST /users` | âœ… | âœ… | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² |
| `POST /users/login` | âœ… | âœ… | ãƒ­ã‚°ã‚¤ãƒ³ |
| `GET /users` | âŒ | âœ… | å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾— |
| `GET /users/{id}` | âœ…â€» | âœ… | ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾— |
| `PUT /users/{id}` | âœ…â€» | âœ… | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–° |
| `DELETE /users/{id}` | âŒ | âœ… | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ |
| `POST /users/admin/create` | âŒ | âœ… | admin ã«ã‚ˆã‚‹æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ |

â€»æœ¬äººã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ³ã‚°

```python
# âŒ é–“é•ã„ï¼šå¹³æ–‡ä¿å­˜
user.password = "password123"

# âœ… æ­£ã—ã„ï¼šãƒãƒƒã‚·ãƒ³ã‚°åŒ–
user.hashed_password = hash_password("password123")
# çµæœ: $2b$12$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7b3XeKeUxG2K87KZgQwa7Ey2a
```

**bcrypt ã®ç‰¹å¾´:**
- ä¸€æ–¹å‘å‡½æ•°ï¼ˆå¾©å·ä¸å¯ï¼‰
- ã‚½ãƒ«ãƒˆè‡ªå‹•ç”Ÿæˆï¼ˆãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«å¯¾ç­–ï¼‰
- ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ãƒãƒƒã‚·ãƒ³ã‚°ï¼ˆè¨ˆç®—æ™‚é–“ãŒæ„å›³çš„ã«é…ã„ â†’ ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–ï¼‰

---

### 2. JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨æ€§

```python
# ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã‚’è¨­å®š
ACCESS_TOKEN_EXPIRE_MINUTES = 60

# JWT ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
payload = {
    "user_id": 1,
    "email": "yamada@example.com",
    "role": "admin",
    "exp": 1730000000  # â† Unix Timestamp ã§å¤±åŠ¹æ™‚åˆ»ã‚’æŒ‡å®š
}
```

**JWT ã®åˆ©ç‚¹:**
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹èªè¨¼ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ DB ä¸è¦ï¼‰
- ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã§æ”¹ã–ã‚“æ¤œçŸ¥
- å¤±åŠ¹æ™‚åˆ»ï¼ˆexpï¼‰ã§è‡ªå‹•æœŸé™ç®¡ç†

---

### 3. ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰

```python
# âŒ æ¨©é™ãƒã‚§ãƒƒã‚¯ ãªã—
def read_users(db: Session = Depends(get_db)):
    return db.query(User).all()

# âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯ ã‚ã‚Šï¼ˆadmin ã®ã¿ï¼‰
def read_users(admin: User = Depends(get_current_admin), db: Session = Depends(get_db)):
    return db.query(User).all()
```

**å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ:**
- `get_current_admin()` ã§ admin ãƒ­ãƒ¼ãƒ«ç¢ºèª
- æ¨©é™ãŒãªã„ â†’ 403 Forbidden ã‚’è¿”ã™
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è©³ç´°ã‚’æ¼ã‚‰ã•ãªã„

---

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
# âŒ è©³ç´°ãªã‚¨ãƒ©ãƒ¼ï¼ˆæ”»æ’ƒã®æ‰‹æ›ã‹ã‚Šã«ãªã‚‹ï¼‰
if not db_user:
    raise HTTPException(detail="Email not found")
if not verify_password(password, db_user.hashed_password):
    raise HTTPException(detail="Invalid password")

# âœ… æ›–æ˜§ãªã‚¨ãƒ©ãƒ¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
if not db_user or not verify_password(password, db_user.hashed_password):
    raise HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"
    )
```

**ç†ç”±:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œãƒ¡ãƒ¼ãƒ«å­˜åœ¨ â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–“é•ã„ã€ã‹åˆ¤å®šã•ã‚Œãªã„
- ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã®é˜²æ­¢

---

## HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æ„å‘³ | ç”¨é€” |
|-----------|------|------|
| `200` | OK | å–å¾—ãƒ»æ›´æ–°æˆåŠŸ |
| `201` | Created | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæˆåŠŸ |
| `204` | No Content | å‰Šé™¤æˆåŠŸ |
| `400` | Bad Request | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ã‚¨ãƒ©ãƒ¼ |
| `401` | Unauthorized | èªè¨¼å¤±æ•—ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãªã—ãƒ»ç„¡åŠ¹ï¼‰ |
| `403` | Forbidden | æ¨©é™ä¸è¶³ï¼ˆadmin ã§ãªã„ç­‰ï¼‰ |
| `404` | Not Found | ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªæ¤œå‡º |
| `409` | Conflict | ãƒ¡ãƒ¼ãƒ«é‡è¤‡ |
| `422` | Unprocessable Entity | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ |

---

## Swagger UI ã§ã®å‹•ä½œç¢ºèª

### ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•
```
http://localhost:8000/docs
```

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

**ã‚·ãƒŠãƒªã‚ª1: é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ â†’ ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§**

1. **POST /users** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
   ```json
   {
     "name": "å±±ç”°å¤ªéƒ",
     "email": "yamada@example.com",
     "password": "password123"
   }
   ```
   æœŸå¾…: 201 Created

2. **POST /users/login** - ãƒ­ã‚°ã‚¤ãƒ³
   ```json
   {
     "email": "yamada@example.com",
     "password": "password123"
   }
   ```
   æœŸå¾…: 200 OKï¼ˆaccess_token ã‚’å–å¾—ï¼‰

3. **GET /users/1** - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§
   ```
   Authorization: Bearer {access_token}
   ```
   æœŸå¾…: 200 OKï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼‰

---

**ã‚·ãƒŠãƒªã‚ª2: Admin ã«ã‚ˆã‚‹å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—**

1. **POST /users/admin/create** - æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆadmin æ¨©é™ï¼‰
   ```
   Authorization: Bearer {admin_token}
   {
     "name": "ç”°ä¸­èŠ±å­",
     "email": "tanaka@example.com",
     "password": "password456"
   }
   ```
   æœŸå¾…: 201 Created

2. **GET /users** - å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆadmin æ¨©é™ï¼‰
   ```
   Authorization: Bearer {admin_token}
   ```
   æœŸå¾…: 200 OKï¼ˆ2ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆï¼‰

3. **GET /users** - å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆuser æ¨©é™ï¼‰
   ```
   Authorization: Bearer {user_token}
   ```
   æœŸå¾…: 403 Forbidden

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¾‹

### ã‚¨ãƒ©ãƒ¼1: ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„

```bash
GET /users/1
(Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ ãªã—)
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "detail": "Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¿…è¦ã§ã™"
}
```
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 401 Unauthorized**

---

### ã‚¨ãƒ©ãƒ¼2: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹

```bash
GET /users/1
Authorization: Bearer invalid_token_123
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "detail": "ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ã™"
}
```
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 401 Unauthorized**

---

### ã‚¨ãƒ©ãƒ¼3: æ¨©é™ä¸è¶³ï¼ˆuser ãŒ admin ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

```bash
GET /users
Authorization: Bearer {user_token}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "detail": "ã“ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç®¡ç†è€…ã®ã¿å®Ÿè¡Œå¯èƒ½ã§ã™"
}
```
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 403 Forbidden**

---

### ã‚¨ãƒ©ãƒ¼4: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„

```bash
POST /users/login
{
  "email": "yamada@example.com",
  "password": "wrong_password"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "detail": "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"
}
```
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 401 Unauthorized**

---

## å­¦ç¿’ã®ãƒã‚¤ãƒ³ãƒˆ

âœ… **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ã‚¢ãƒãƒƒã‚·ãƒ³ã‚°**
- bcrypt + passlib ã§å®‰å…¨ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿å­˜
- å¾©å·ä¸å¯ï¼ˆä¸€æ–¹å‘å‡½æ•°ï¼‰
- ã‚½ãƒ«ãƒˆè‡ªå‹•ç”Ÿæˆã§å®‰å…¨æ€§å‘ä¸Š

âœ… **JWT ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼**
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹èªè¨¼ã®å®Ÿè£…
- ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã§æ”¹ã–ã‚“æ¤œçŸ¥
- å¤±åŠ¹æ™‚åˆ»ï¼ˆexpï¼‰ã«ã‚ˆã‚‹è‡ªå‹•æœŸé™ç®¡ç†

âœ… **ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰**
- ä¾å­˜æ€§æ³¨å…¥ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
- admin / user ãƒ­ãƒ¼ãƒ«åˆ†é›¢
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå˜ä½ã§ã®æ¨©é™åˆ¶å¾¡

âœ… **ä¾å­˜æ€§æ³¨å…¥ï¼ˆDependency Injectionï¼‰**
- `Depends()` ã§å†åˆ©ç”¨å¯èƒ½ãªèªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
- `get_current_user()` ã§èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
- `get_current_admin()` ã§ admin æ¨©é™ç¢ºèª

âœ… **ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
- 401 Unauthorized: èªè¨¼å¤±æ•—
- 403 Forbidden: æ¨©é™ä¸è¶³
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è©³ç´°ã‚’æ¼ã‚‰ã•ãªã„

âœ… **HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä½¿ã„åˆ†ã‘**
- 201: æ–°è¦ä½œæˆæˆåŠŸ
- 204: å‰Šé™¤æˆåŠŸ
- 401: èªè¨¼å¤±æ•—
- 403: æ¨©é™ä¸è¶³
- 409: ãƒªã‚½ãƒ¼ã‚¹ç«¶åˆ

---

## å‹•ä½œç¢ºèªã‚³ãƒãƒ³ãƒ‰

### ãƒ“ãƒ«ãƒ‰ãƒ»èµ·å‹•
```bash
docker-compose down
docker-compose up --build
```

### ãƒ­ã‚°ç¢ºèª
```bash
docker-compose logs -f fastapi
```

### Swagger UI ã«ã‚¢ã‚¯ã‚»ã‚¹
```
http://localhost:8000/docs
```

### PostgreSQL ã§ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
```bash
docker-compose exec db psql -U postgres -d fastapi_db -c "SELECT * FROM users;"
```

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆä¾‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
hashed = pwd_context.hash("password123")
print(hashed)
# å‡ºåŠ›: $2b$12$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7b3XeKeUxG2K87KZgQwa7Ey2a
```

### åœæ­¢
```bash
docker-compose down
```

---

## ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºæ–¹æ³•

### ã‚¨ãƒ©ãƒ¼1: "ModuleNotFoundError: No module named 'passlib'"

**åŸå› :** passlib ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„

**è§£æ±º:**
```bash
pip install passlib==1.7.4
# Docker ã®å ´åˆ
docker-compose down
docker-compose up --build
```

---

### ã‚¨ãƒ©ãƒ¼2: "401 Unauthorized" ãŒè¿”ã•ã‚Œã‚‹

**åŸå› :**
- Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„
- ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹
- ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œ

**ç¢ºèª:**
```bash
# âœ… æ­£ã—ã„
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

# âŒ é–“é•ã„
Authorization: eyJhbGciOiJIUzI1NiIs...  ï¼ˆBearer ãŒç„¡ã„ï¼‰
Authorization: Bearer invalid_token      ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ï¼‰
```

---

### ã‚¨ãƒ©ãƒ¼3: "403 Forbidden" ãŒè¿”ã•ã‚Œã‚‹

**åŸå› :** ãƒ­ãƒ¼ãƒ«æ¨©é™ä¸è¶³ï¼ˆuser ãŒ admin ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

**ç¢ºèª:**
```python
# user ãƒ­ãƒ¼ãƒ«ã§ GET /usersï¼ˆadmin ã®ã¿ï¼‰ â†’ 403 Forbidden
# user ãƒ­ãƒ¼ãƒ«ã§ GET /users/{id}ï¼ˆæœ¬äººï¼‰ â†’ 200 OK
# admin ãƒ­ãƒ¼ãƒ«ã§ GET /usersï¼ˆadmin ã®ã¿ï¼‰ â†’ 200 OK
```

---

### ã‚¨ãƒ©ãƒ¼4: "422 Unprocessable Entity"

**åŸå› :** ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—

**ç¢ºèª:**
```json
// âŒ ãƒ¡ãƒ¼ãƒ«å½¢å¼ãŒä¸æ­£
{
  "name": "å±±ç”°å¤ªéƒ",
  "email": "invalid-email",
  "password": "password123"
}

// âœ… æ­£ã—ã„å½¢å¼
{
  "name": "å±±ç”°å¤ªéƒ",
  "email": "yamada@example.com",
  "password": "password123"
}
```

---

## ãƒ•ã‚§ãƒ¼ã‚º4ã§ã®å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- âœ… `requirements.txt` ã« bcrypt, passlib, python-jose, python-multipart ã‚’è¿½åŠ 
- âœ… `models.py` ã« hashed_password, role, is_active ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
- âœ… `schemas.py` ã« UserCreate.password, TokenPayload, LoginResponse ã‚’è¿½åŠ 
- âœ… æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `security.py` ã‚’ä½œæˆ
- âœ… `routers/users.py` ã‚’ä¿®æ­£ï¼ˆ7ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
- âœ… `Dockerfile` ã« `security.py` ã‚’è¿½åŠ 
- âœ… DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- âœ… `docker-compose up --build` ã§èµ·å‹•
- âœ… Swagger UI ã§å‹•ä½œç¢ºèª
- âœ… ç®¡ç†è€…ãƒ­ãƒ¼ãƒ« user ã‚’ä½œæˆ
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² â†’ ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã®æµã‚Œã‚’ç¢ºèª
- âœ… Admin ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ç­‰ï¼‰ã®æ¨©é™ç¢ºèª

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5ã®äºˆå‘Šï¼‰

ãƒ•ã‚§ãƒ¼ã‚º5ã§ã¯ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¾ã™ï¼š

- **é«˜åº¦ãªãƒ­ãƒ¼ãƒ«ç®¡ç†**
  - ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ç´°åˆ†åŒ–
  - ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«å®šç¾©

- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**
  - ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  - ãƒ­ã‚®ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
  - ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
  - ã‚¯ã‚¨ãƒªæœ€é©åŒ–
  - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

- **ãƒ†ã‚¹ãƒˆå®Ÿè£…**
  - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  - çµ±åˆãƒ†ã‚¹ãƒˆ
  - E2E ãƒ†ã‚¹ãƒˆ

---

## å®Œæˆæ—¥

**ãƒ•ã‚§ãƒ¼ã‚º4å®Œäº†æ—¥:** 2025-11-08
**é€²æ—:** 4/4 ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†

---

## å‚è€ƒãƒªãƒ³ã‚¯

- FastAPI å…¬å¼ï¼šhttps://fastapi.tiangolo.com/
- SQLAlchemy å…¬å¼ï¼šhttps://docs.sqlalchemy.org/
- passlib å…¬å¼ï¼šhttps://passlib.readthedocs.io/
- python-jose å…¬å¼ï¼šhttps://python-jose.readthedocs.io/
- JWT å…¬å¼ï¼šhttps://jwt.io/
- bcrypt å…¬å¼ï¼šhttps://github.com/pyca/bcrypt
- Pydantic å…¬å¼ï¼šhttps://docs.pydantic.dev/
- HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼šhttps://developer.mozilla.org/ja/docs/Web/HTTP/Status

---

ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ãƒ•ã‚§ãƒ¼ã‚º4ã‚’å®Œäº†ã—ã¾ã—ãŸ ğŸ‰

## ğŸ“ å­¦ç¿’æˆæœã®ã¾ã¨ã‚

ãƒ•ã‚§ãƒ¼ã‚º1ã€œ4ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ãŸï¼š

âœ… **ãƒ•ã‚§ãƒ¼ã‚º1**: ç’°å¢ƒæ§‹ç¯‰ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
âœ… **ãƒ•ã‚§ãƒ¼ã‚º2**: ãƒ¢ãƒ‡ãƒ«ãƒ»ã‚¹ã‚­ãƒ¼ãƒãƒ»DBæ¥ç¶šè¨­å®š
âœ… **ãƒ•ã‚§ãƒ¼ã‚º3**: CRUD ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ»ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ãƒ»ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
âœ… **ãƒ•ã‚§ãƒ¼ã‚º4**: èªè¨¼ãƒ»èªå¯ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ãƒ»ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹åˆ¶å¾¡

### ç·æ‹¬

æœ¬ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã§ã¯ã€FastAPI ã¨ PostgreSQL ã‚’çµ„ã¿åˆã‚ã›ãŸå®Ÿè·µçš„ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚’å­¦ã³ã¾ã—ãŸã€‚
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ã€JWT èªè¨¼ã€ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãªã©ã€æœ¬ç•ªç’°å¢ƒã§å¿…é ˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®å®Ÿè£…æ–¹æ³•ã‚’ç¿’å¾—ã—ã¾ã—ãŸã€‚

ã“ã®ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆã¯ã€ä»¥ä¸‹ã®é–‹ç™ºã«ç›´çµã—ã¾ã™ï¼š

- REST API é–‹ç™º
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- èªè¨¼ãƒ»èªå¯æ©Ÿèƒ½
- ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†

**ãœã²ã€ã“ã®ã‚¹ã‚­ãƒ«ã‚’å®Ÿå‹™ã§æ´»ã‹ã—ã¦ãã ã•ã„ï¼** ğŸš€
